# 操作系统大作业报告
# Shell改进

## 选题
方案一：对xv6操作系统的Shell功能的新增与改进。涉及的部分包括但不限于基础命令相关、文件管理、文档编辑。

## 人员组成
* 陈曦 2016013275
* 吴海旭 2016013223
* 山本宇多子 2016080045
* 苏宇荣 2015080045

## 开发环境
* 系统：Ubuntu 16.04 LTS + QEMU
* 编程语言：C

## 实现的功能
### 1. 基础命令
#### 1.1 支持自动补全
#### 1.2 支持自动修复命令
#### 1.3 支持查看历史命令
#### 1.4 支持调用历史命令
#### 1.5 支持光标的移动操作
#### 1.6 支持向前编辑操作

### 2. 文件管理

### 3. 文档编辑

#### 3.1 实现功能

本工作计划实现vim的文本编辑功能。具体实现内容如下：

- 实现读取已有文件与创建并保存文件
- 实现命令、编辑模式
- 实现任意位置的插入与删除操作
- 实现代码高亮和显示行号等用户友好的功能

####3.2 技术实现详情

具体实现框架如图：

![文本编辑说明](C:\Users\wuhaixu\Documents\GitHub\xv6_OS\report\文本编辑说明.jpg)

一些说明如下：

- 对于文件内容，我们以行为分割，一行为一个数组，n行组成数组链表，每行规定字符最多为80
- 文件编辑过程，实际上是一个不断更新命令行输出的过程

##### 3.2.1 文件读取与保存

实现open_file函数将文件读入（系统调用open函数）获取文件指针，实现load_file函数，将文件内容转存到上面提到的数组链表中，通过output函数将内容输出到命令行。

实现save函数将数组链表中内容写入文件（系统调用write函数）。

##### 3.2.2 命令与编辑模式

实现两个模式visual mode与edit mode。

在visual mode中通过输入特定字母从而调用关闭文件（q）、保存文件（s）、编辑文件（e）的相关功能模块，方便用户使用。

在edit mode中，我们实现的具体流程如下：

- 读入用户缓存区
- 将缓存区内容进行特定字符的识别：方向键表示换行等
- 重写数组链表内容
- 重新输出命令行窗口

在实现插入删除操作时，因为数组为内容中连续空间，我们使用memmove函数实现数组链表内容的改写。

在重新输出命令行窗口时，我们实现系统调用setconsole来设置输出结果的颜色。

> 注意：我们在edit mode中仅仅改变数组链表的内容，只有在visual mode 中选择save才会将数组链表的内容写入文件。

#####3.2.3 任意位置插入与删除

我们使用current_par指向当前行内容的数组，使用screen_par指针指向所有内容的起始（写入文件时会用到），同时为了记录一行内的字符定位，我们还定义数值edit_index来存储当前的光标在一行中的位置。

任意位置的插入与删除的核心在于光标定址。

读取输入缓存区时，使用上下键时，我们进行current_par的前移与后移。使用左右键时，我们进行edit_index的减少与增加。

光标定址结束之后，我们在通过相应命令来实现current_par指向数组的改写。

#####3.2.4 用户友好设计

为了增强用户友好性，我们实现了输出行号与代码高亮。

为实现输出行号，我们改写之前的output函数，在输出每行内容前输入current_par编号。

为实现代码高亮，我们实现系统调用setconsole来设置输出结果的颜色，并与已有代码进行字符串匹配。

####3.3 技术难点

#####3.3.1 设计数据结构实现文件读取写入

文本编辑功能如果需要实现文件读取则需要考虑换行问题，为了清晰的描述每行内容，我们设计以行为单位进行数据的存储，这一设计也使后面的数据结构优化更加方便。

#####3.3.2 优化数据结构实现光标定位

为了实现任意位置插入与删除，我们需要准确定位光标的位置，因为在最开始设计数据结构的时候，我们已经将数据按照行来存储，这样就不难想到，先确定行号，再确定行内编号，所以我们使用edit_index来定位行内编号。

####3.4 用户手册

- 输入命令行edit filename ，若存在文件则打开，否则新建文件
- 进入visual mode，输入e进入edit mode，输入q退出，输入s保存文件
- 进入edit mode，具体操作下面详细说明，esc退出edit mode进入visual mode

edit mode中具体操作如下：

| 功能          | 实现方式                                                     | 备注                                        |
| ------------- | ------------------------------------------------------------ | ------------------------------------------- |
| 写入字母      | 在draft中相应位置输入，按下enter                             |                                             |
| 删除字母      | 在draft中相应位置输入‘@’，输入一个‘@’表示删除一个字符，按下enter |                                             |
| 换行          | 上下键，输入一个字符后需要按下enter进行更新                  | 输入一个字符，若想使字符生效则需要按下enter |
| 左右移动光标  | 左右键，可以连续移动                                         |                                             |
| 退出edit mode | 按下esc，按下enter                                           |                                             |

### 4. 其它
#### 4.1 命令行式计算器

请选择方案一的同学在此提交实验材料，包括：

src文件夹：存放源码（代码规范，英文注释）

report文件夹：存放实验报告（说清楚做了什么，例如技术实现详情、技术难点、成员分工、参考引用），用户手册（说清楚如何使用程序，例如环境、配置、运行、操作），展示PPT

lib文件夹（可选）：如果用到外部库，放在该文件夹

readme（可选）：如有其它文件夹或文件，对每个文件夹和文件进行说明

只需组长提交即可，文件名为“组长学号_组长姓名_方案一.压缩文件后缀”

截止时间为18周周五，请大家合理安排时间